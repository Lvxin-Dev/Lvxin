<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Contract Comparison Tool</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --primary: #1768e4;
      --secondary: #6C5CE7;
      --success: #00B894;
      --danger: #D63031;
      --warning: #FDCB6E;
      --background: #ffffff;
      --text-primary: #1a1a1a;
      --text-secondary: #666666;
      --border: #e0e0e0;
      --card-bg: #f8f9fa;
      --nav-bg: rgba(255, 255, 255, 0.95);
      --gradient-start: #4A90E2;
      --gradient-end: #6C5CE7;
      --sidebar-width: 200px;
      --ls-bg: #ffffff;
      --ls-text: #1a1a1a;
      --ls-primary: #0b6efd;
      --ls-secondary: #6c757d;
      --ls-border: #e0e0e0;
      --ls-card-bg: #f8f9fa;
      --ls-hover: #f0f2f5;
      --border-radius: 8px;
      --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
      --accent: #FBBF24; /* yellow-400 */
      --accent-hover: #F59E0B; /* yellow-500 */
    }

    [data-theme="dark"] {
      --primary: #6366F1;
      --primary-hover: #4F46E5;
      --primary-light: #A5B4FC;
      --secondary: #8B5CF6;
      --secondary-hover: #7C3AED;
      --secondary-light: #C4B5FD;
      --accent: #FBBF24;
      --accent-hover: #F59E0B;
      --success: #34D399;
      --success-hover: #10B981;
      --background: #0F172A;
      --text-primary: #F9FAFB;
      --text-secondary: #9CA3AF;
      --border: #374151;
      --border-light: #1F2937;
      --nav-bg: rgba(17, 24, 39, 0.98);
      --card-bg: #1F2937;
      --hover-bg: #1F2937;
      --ls-bg: #1F2937;
      --ls-text: #F9FAFB;
      --ls-primary: #6366F1;
      --ls-secondary: #8B5CF6;
      --ls-border: #374151;
      --ls-card-bg: #1F2937;
      --ls-hover: #374151;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', 'Poppins', system-ui, sans-serif;
      transition: all 0.2s ease;
    }

    body {
      background: var(--background);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Navigation Bar */
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.8rem 2rem;
      background: var(--nav-bg);
      backdrop-filter: blur(8px);
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 1000;
      box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
      border-bottom: 1px solid var(--border);
    }

    .logo img {
      height: 30px;
      transition: transform 0.3s ease;
      filter: drop-shadow(0 3px 6px rgba(74, 144, 226, 0.3));
      border-radius: 8px;
      background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
      padding: 3px;
    }

    .logo:hover img {
      transform: scale(1.05) rotate(4deg);
      filter: drop-shadow(0 4px 8px rgba(74, 144, 226, 0.5));
    }

    .nav-links {
      display: flex;
      gap: 1.5rem;
      align-items: center;
    }

    .nav-links a {
      color: var(--text-primary);
      text-decoration: none;
      font-weight: 500;
      font-size: 0.9rem;
    }

    .nav-links a:hover {
      color: var(--primary);
      background: var(--ls-hover);
      border-radius: 5px;
      padding: 0.3rem 0.5rem;
    }

    .actions {
      display: flex;
      gap: 0.8rem;
      align-items: center;
    }

    .icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.4rem;
      color: var(--text-primary);
      font-size: 1rem;
      border-radius: 50%;
    }

    .icon-btn:hover {
      color: var(--primary);
      background: var(--ls-hover);
      transform: scale(1.05);
    }

    .primary-btn {
      background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
      color: white;
      padding: 0.4rem 1rem;
      border-radius: 20px;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .primary-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(74, 144, 226, 0.3);
    }

    /* Profile Component */
    .profile-component {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      background: rgba(74, 144, 226, 0.1);
      border: 1.5px solid var(--primary);
      text-decoration: none;
      font-size: 0.85rem;
    }

    .profile-component:hover {
      background: rgba(74, 144, 226, 0.2);
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(74, 144, 226, 0.1);
    }

    .profile-image {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      object-fit: cover;
      border: 1.5px solid white;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }

    .profile-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.85rem;
    }

    /* Main Content */
    .container {
      display: flex;
      flex-direction: column;
      max-width: 100%;
      align-items: center;
      padding: 20px;
      flex: 1;
      margin-top: 60px;
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
      width: 100%;
      padding: 20px 0;
      position: relative;
    }

    .header h1 {
      font-size: 2.5rem;
      color: var(--primary);
      margin-bottom: 10px;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .header p {
      font-size: 1.1rem;
      color: var(--text-secondary);
      max-width: 700px;
      margin: 0 auto;
    }

    .comparison-wrapper {
      width: 100%;
      max-width: 1800px;
      overflow: hidden;
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      border: 1px solid var(--border);
    }
    
    .comparison-container {
      display: flex;
      gap: 10px;
      width: 100%;
      height: calc(100vh - 200px);
      min-height: 500px;
    }
    
    .pdf-viewer {
      width: 50%;
      box-sizing: border-box;
      border: 1px solid var(--border);
      background: var(--card-bg);
      overflow: auto;
      position: relative;
      transition: var(--transition);
    }

    .pdf-viewer:hover {
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
    }

    .pdf-title {
      position: sticky;
      top: 0;
      background: var(--primary);
      color: white;
      padding: 15px 20px;
      margin: 0;
      z-index: 100;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .pdf-title .badge {
      background: rgba(255,255,255,0.2);
      padding: 3px 8px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .pdf-content {
      padding: 25px;
      font-family: 'Courier New', monospace;
      white-space: pre-wrap;
      line-height: 1.6;
      font-size: 14px;
      overflow: auto;
      color: var(--text-primary);
      word-break: break-word;
      flex: 1;
      height: calc(100% - 60px);
    }

    .modified {
      border-left: 2px solid var(--border);
    }

    .highlight-high {
      background-color: rgba(247, 37, 133, 0.15);
      padding: 0 2px;
      border-left: 3px solid var(--danger);
      border-radius: 0 3px 3px 0;
      position: relative;
      transition: var(--transition);
    }

    .highlight-medium {
      background-color: rgba(247, 127, 0, 0.15);
      padding: 0 2px;
      border-left: 3px solid var(--warning);
      border-radius: 0 3px 3px 0;
      position: relative;
      transition: var(--transition);
    }

    .highlight-replacement {
      background-color: rgba(76, 201, 240, 0.15);
      padding: 0 2px;
      border-left: 3px solid var(--success);
      border-radius: 0 3px 3px 0;
      position: relative;
      transition: var(--transition);
    }

    .action-section {
      margin-bottom: 20px;
      padding: 25px;
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      text-align: center;
      width: 100%;
      max-width: 800px;
      transition: var(--transition);
      border: 1px solid var(--border);
    }

    .action-section:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }

    .action-section h2 {
      margin-bottom: 20px;
      color: var(--primary);
      font-weight: 500;
    }

    .legend {
      display: flex;
      justify-content: center;
      gap: 25px;
      margin-bottom: 20px;
      width: 100%;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--card-bg);
      padding: 8px 15px;
      border-radius: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid var(--border);
    }

    .legend-color {
      width: 18px;
      height: 18px;
      border-radius: 3px;
    }

    .high-color {
      background-color: rgba(247, 37, 133, 0.15);
      border-left: 3px solid var(--danger);
    }

    .medium-color {
      background-color: rgba(247, 127, 0, 0.15);
      border-left: 3px solid var(--warning);
    }

    .replacement-color {
      background-color: rgba(76, 201, 240, 0.15);
      border-left: 3px solid var(--success);
    }

    .loading {
      text-align: center;
      padding: 40px;
      font-size: 1.1rem;
      color: var(--text-secondary);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(67, 97, 238, 0.2);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error {
      color: var(--danger);
      padding: 15px;
      text-align: center;
      background: rgba(247, 37, 133, 0.1);
      border-radius: var(--border-radius);
      margin: 20px 0;
      max-width: 800px;
      width: 100%;
    }

    .modification-tooltip {
      position: relative;
      display: inline;
      cursor: pointer;
    }

    .modification-tooltip .tooltiptext {
      visibility: hidden;
      width: 300px;
      background-color: var(--background);
      color: var(--text-primary);
      text-align: left;
      border-radius: var(--border-radius);
      padding: 12px;
      position: absolute;
      z-index: 1000;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      font-family: 'Inter', sans-serif;
      white-space: normal;
      font-size: 0.9rem;
      line-height: 1.5;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border: 1px solid var(--border);
    }

    .modification-tooltip .tooltiptext::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: var(--border) transparent transparent transparent;
    }

    .modification-tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }

    .tooltip-title {
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tooltip-title i {
      font-size: 1rem;
    }

    .high-tooltip .tooltip-title {
      color: #ff9bb3;
    }

    .medium-tooltip .tooltip-title {
      color: #ffc77d;
    }

    .replacement-tooltip .tooltip-title {
      color: #a5e8ff;
    }

    button {
      padding: 12px 24px;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    button:hover {
      background-color: var(--secondary);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      background-color: var(--ls-secondary);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    button i {
      font-size: 0.9rem;
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }

    .btn-outline:hover {
      background: rgba(67, 97, 238, 0.1);
    }

    .btn-danger {
      background-color: var(--danger);
    }

    .btn-danger:hover {
      background-color: #e5177e;
    }

    .btn-warning {
      background-color: var(--warning);
    }

    .btn-warning:hover {
      background-color: #e67500;
    }

    .btn-success {
      background-color: var(--success);
    }

    .btn-success:hover {
      background-color: #3ab7d8;
    }

    #exportBtn {
      position: absolute;
      top: 20px;
      right: 20px;
      display: none;
      background-color: var(--accent);
      padding: 10px 20px;
      font-size: 0.9rem;
    }

    #exportBtn:hover {
      background-color: var(--accent-hover);
    }

    .stats {
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.1rem;
      color: var(--text-primary);
      width: 100%;
      background: var(--card-bg);
      padding: 15px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      display: flex;
      justify-content: center;
      gap: 30px;
      flex-wrap: wrap;
      border: 1px solid var(--border);
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .stat-value {
      font-weight: 700;
      font-size: 1.2rem;
    }

    .high-stat {
      color: var(--danger);
    }

    .medium-stat {
      color: var(--warning);
    }

    .navigation-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
      width: 100%;
      padding: 20px 0;
    }

    .navigation-buttons button {
      padding: 12px 30px;
      min-width: 180px;
    }

    #prevBtn {
      background-color: var(--warning);
    }

    #prevBtn:hover {
      background-color: #e67500;
    }

    #nextBtn {
      background-color: var(--success);
    }

    #nextBtn:hover {
      background-color: 3ab7d8;
    }

    .current-highlight {
      animation: pulse 1.5s infinite;
      position: relative;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(67, 97, 238, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(67, 97, 238, 0); }
      100% { box-shadow: 0 0 0 0 rgba(67, 97, 238, 0); }
    }

    .progress-container {
      width: 100%;
      max-width: 800px;
      background: var(--ls-hover);
      border-radius: 10px;
      margin: 20px 0;
      height: 10px;
      overflow: hidden;
      display: none;
    }

    .progress-bar {
      height: 100%;
      background: var(--primary);
      width: 0%;
      transition: width 0.3s ease;
    }

    .status-text {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-top: 5px;
      text-align: center;
    }

    .empty-state {
      text-align: center;
      padding: 50px 20px;
      color: var(--text-secondary);
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 20px;
      color: var(--ls-hover);
    }

    .empty-state h3 {
      margin-bottom: 10px;
      color: var(--text-primary);
    }

    .empty-state p {
      max-width: 500px;
      margin: 0 auto;
    }

    /* Export Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background-color: var(--card-bg);
      margin: 15% auto;
      padding: 25px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      width: 90%;
      max-width: 500px;
      animation: modalFadeIn 0.3s;
      border: 1px solid var(--border);
    }

    @keyframes modalFadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h2 {
      color: var(--primary);
      font-size: 1.5rem;
    }

    .close-modal {
      color: var(--text-secondary);
      font-size: 1.5rem;
      font-weight: bold;
      cursor: pointer;
    }

    .close-modal:hover {
      color: var(--text-primary);
    }

    .export-options {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .export-option {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 15px;
      border-radius: var(--border-radius);
      background: var(--ls-hover);
      cursor: pointer;
      transition: var(--transition);
      border: 1px solid var(--border);
    }

    .export-option:hover {
      background: var(--ls-card-bg);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .export-option-title {
      font-weight: 600;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .export-option-desc {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    /* Responsive styles */
    @media (max-width: 1200px) {
      .comparison-container {
        flex-direction: column;
        height: auto;
      }
    
      .pdf-viewer {
        width: 100%;
        height: 50%;
      }
    
      .header h1 {
        font-size: 2rem;
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 15px;
        margin-top: 60px;
      }
    
      .header h1 {
        font-size: 1.8rem;
      }
    
      .header p {
        font-size: 1rem;
      }
    
      .legend {
        flex-direction: column;
        gap: 15px;
      }
    
      .stats {
        flex-direction: column;
        gap: 15px;
        padding: 15px 10px;
      }
    
      .navigation-buttons {
        flex-direction: column;
        gap: 15px;
      }
    
      .navigation-buttons button {
        width: 100%;
      }
    
      #exportBtn {
        position: static;
        margin-top: 15px;
        display: none;
        width: 100%;
      }

      .navbar {
        padding: 10px 15px;
      }

      .nav-links {
        gap: 15px;
      }

      .modal-content {
        margin: 20% auto;
        width: 95%;
      }
    }
  </style>
</head>
<body>
    <!-- Header -->
    <nav class="navbar">
        <div class="logo">
            <a href="welcome_page">
                <img src="../static/images/logo.jpg" alt="Company Logo">
            </a>
        </div>

        <div class="nav-links">
            <a href="subscriptions" class="en-content">Pricing</a>
            <a href="aboutus" class="en-content">About Us</a>
            <a href="helpcenter" class="en-content">Help Center</a>
        </div>
        <div class="actions">
            <button id="themeToggle" class="icon-btn">
                <i class="fas fa-moon"></i>
            </button>
            <!-- Elfsight website translator -->
            <script src="https://static.elfsight.com/platform/platform.js" async></script>
            <div class="elfsight-app-fce75b10-069c-41d5-bca0-09c33e812801" data-elfsight-app-lazy></div>

            <a href="profile" class="profile-component">
                <img src="../static/images/profile.jpeg" class="profile-image" alt="Profile Image">
                <span class="profile-name">{{name}}</span>
            </a>
        </div>
    </nav>

  <div class="container">
    <div class="header">
      <h1>Contract Comparison</h1>
      <p>Analyze and visualize suggested modifications with risk assessment for your contract</p>
      <button id="exportBtn"><i class="fas fa-file-export"></i> Export PDF</button>
    </div>

    <div class="action-section">
      <h2><i class="fas fa-file-contract"></i> Contract Analysis</h2>
      <button id="analyzeBtn"><i class="fas fa-cogs"></i> Analyze Contract</button>
      <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
        <div class="status-text" id="statusText">Processing...</div>
      </div>
    </div>

    <div id="stats" class="stats" style="display: none;">
      <div class="stat-item">
        <span>High Risk Issues:</span>
        <span class="stat-value high-stat" id="highCount">0</span>
      </div>
      <div class="stat-item">
        <span>Medium Risk Issues:</span>
        <span class="stat-value medium-stat" id="mediumCount">0</span>
      </div>
      <div class="stat-item">
        <span>Total Modifications:</span>
        <span class="stat-value" id="totalCount">0</span>
      </div>
    </div>

    <div class="legend">
      <div class="legend-item">
        <div class="legend-color high-color"></div>
        <span>High Risk Modifications</span>
      </div>
      <div class="legend-item">
        <div class="legend-color medium-color"></div>
        <span>Medium Risk Modifications</span>
      </div>
      <div class="legend-item">
        <div class="legend-color replacement-color"></div>
        <span>Suggested Replacements</span>
      </div>
    </div>

    <div id="loading" class="loading" style="display: none;">
      <div class="loading-spinner"></div>
      <p>Analyzing your document, please wait...</p>
      <p id="loadingStatus">Extracting text from PDF</p>
    </div>

    <div id="error" class="error" style="display: none;">
      <i class="fas fa-exclamation-circle"></i>
      <span id="errorText"></span>
    </div>

    <div class="comparison-wrapper">
      <div id="comparison" class="comparison-container" style="display: none;">
        <div class="pdf-viewer" id="originalViewer">
          <h3 class="pdf-title">
            <span><i class="fas fa-file-alt"></i> Original Contract</span>
            <span class="badge" id="originalStats">0 issues</span>
          </h3>
          <div id="originalPdf" class="pdf-content"></div>
        </div>
        <div class="pdf-viewer modified" id="modifiedViewer">
          <h3 class="pdf-title">
            <span><i class="fas fa-file-signature"></i> Modified Contract</span>
            <span class="badge" id="modifiedStats">0 changes</span>
          </h3>
          <div id="modifiedPdf" class="pdf-content"></div>
        </div>
      </div>
    
      <div id="emptyState" class="empty-state">
        <i class="fas fa-file-contract"></i>
        <h3>Ready for Analysis</h3>
        <p>Click the "Analyze Contract" button to begin processing your document and view suggested modifications with risk assessment.</p>
      </div>
    </div>

    <div id="navigation" class="navigation-buttons" style="display: none;">
      <button id="prevBtn"><i class="fas fa-chevron-left"></i> Previous Issue</button>
      <button id="nextBtn">Next Issue <i class="fas fa-chevron-right"></i></button>
    </div>
  </div>

  <!-- Export Modal -->
  <div id="exportModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fas fa-file-export"></i> Export Options</h2>
        <span class="close-modal">&times;</span>
      </div>
      <div class="export-options">
        <div class="export-option" id="exportFullModified">
          <div class="export-option-title">
            <i class="fas fa-file-pdf"></i> Full Modified Contract
          </div>
          <div class="export-option-desc">
            Download the complete modified contract with all changes applied.
          </div>
        </div>
        <div class="export-option" id="exportModificationsOnly">
          <div class="export-option-title">
            <i class="fas fa-list"></i> Modifications Summary
          </div>
          <div class="export-option-desc">
            Download a summary document with just the modifications (original and modified content).
          </div>
        </div>
      </div>
    </div>
  </div>

 <script>
    // Initialize PDF.js with proper CMAP for Chinese characters
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
    const { jsPDF } = window.jspdf;
    var jsonData = {};
    // Global variables for issue navigation
    let modifications = [];
    let currentIssueIndex = -1;
    let issueElements = [];
    let originalText = '';
    let isScrolling = false;

    // DOM elements
    const analyzeBtn = document.getElementById('analyzeBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const statusText = document.getElementById('statusText');
    const loadingStatus = document.getElementById('loadingStatus');
    const emptyState = document.getElementById('emptyState');
    const themeToggle = document.getElementById('themeToggle');
    const originalViewer = document.getElementById('originalViewer');
    const modifiedViewer = document.getElementById('modifiedViewer');
    const exportModal = document.getElementById('exportModal');
    const closeModal = document.querySelector('.close-modal');
    const exportFullModified = document.getElementById('exportFullModified');
    const exportModificationsOnly = document.getElementById('exportModificationsOnly');

    // Theme toggle functionality
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      if (currentTheme === 'dark') {
        document.documentElement.removeAttribute('data-theme');
        themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
        localStorage.setItem('theme', 'light');
      } else {
        document.documentElement.setAttribute('data-theme', 'dark');
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        localStorage.setItem('theme', 'dark');
      }
    }

    // Check for saved theme preference
    function checkThemePreference() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      if (savedTheme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
      } else {
        document.documentElement.removeAttribute('data-theme');
        themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
      }
    }

    // Synchronize scrolling between viewers
    function syncScroll(source, target) {
      if (isScrolling) return;
      
      isScrolling = true;
      
      const sourceScrollRatio = source.scrollTop / (source.scrollHeight - source.clientHeight);
      const targetScrollTop = sourceScrollRatio * (target.scrollHeight - target.clientHeight);
      
      target.scrollTop = targetScrollTop;
      
      setTimeout(() => {
        isScrolling = false;
      }, 100);
    }

    // Set up event listeners
    function initEventListeners() {
      themeToggle.addEventListener('click', toggleTheme);
      analyzeBtn.addEventListener('click', analyzeDocument);
      document.getElementById('exportBtn').addEventListener('click', () => {
        exportModal.style.display = 'block';
      });
      document.getElementById('prevBtn').addEventListener('click', () => {
        if (currentIssueIndex > 0) navigateToIssue(currentIssueIndex - 1);
      });
      document.getElementById('nextBtn').addEventListener('click', () => {
        if (currentIssueIndex < issueElements.length - 1) navigateToIssue(currentIssueIndex + 1);
      });
      originalViewer.addEventListener('scroll', () => syncScroll(originalViewer, modifiedViewer));
      modifiedViewer.addEventListener('scroll', () => syncScroll(modifiedViewer, originalViewer));
      closeModal.addEventListener('click', () => exportModal.style.display = 'none');
      window.addEventListener('click', (event) => {
        if (event.target === exportModal) exportModal.style.display = 'none';
      });
      exportFullModified.addEventListener('click', exportModifiedPDF);
      exportModificationsOnly.addEventListener('click', exportModificationsSummary);
    }

    function analyzeDocument() {
      const pdfPath = "{{ file_path}}";
  
      console.log("the pdfPath is:")
      console.log(pdfPath);
      document.getElementById('loading').style.display = 'flex';
      document.getElementById('error').style.display = 'none';
      document.getElementById('comparison').style.display = 'none';
      document.getElementById('navigation').style.display = 'none';
      progressContainer.style.display = 'block';
      analyzeBtn.disabled = true;
      emptyState.style.display = 'none';
    
      processPdf(pdfPath);
    }

    function extractModifications(jsonData) {
      const modifications = [];
      let highCount = 0;
      let mediumCount = 0;

      jsonData.forEach(item => {
        if (!item.Output || !item.Output.result) return;

        const result = item.Output.result;
      
        if (!result.riskLevel || result.riskLevel === 'normal') return;

        if (result.originalContent && result.resultContent) {
          modifications.push({
            originalContent: result.originalContent.trim(),
            resultContent: result.resultContent.trim(),
            riskLevel: result.riskLevel,
            ruleTitle: result.ruleTitle,
            riskExplain: result.riskExplain || result.examineBrief
          });

          if (result.riskLevel === 'high') highCount++;
          else if (result.riskLevel === 'medium') mediumCount++;
        }

        if (result.subRisks && result.subRisks.length > 0) {
          result.subRisks.forEach(subRisk => {
            if (subRisk.originalContent && subRisk.resultContent) {
              modifications.push({
                originalContent: subRisk.originalContent.trim(),
                resultContent: subRisk.resultContent.trim(),
                riskLevel: result.riskLevel,
                ruleTitle: result.ruleTitle,
                riskExplain: subRisk.riskExplain || subRisk.riskBrief
              });

              if (result.riskLevel === 'high') highCount++;
              else if (result.riskLevel === 'medium') mediumCount++;
            }
          });
        }
      });

      document.getElementById('highCount').textContent = highCount;
      document.getElementById('mediumCount').textContent = mediumCount;
      document.getElementById('totalCount').textContent = modifications.length;
      document.getElementById('stats').style.display = 'flex';
    
      document.getElementById('originalStats').textContent = `${highCount + mediumCount} issues`;
      document.getElementById('modifiedStats').textContent = `${modifications.length} changes`;

      modifications.sort((a, b) => b.originalContent.length - a.originalContent.length);
      return modifications;
    }

    async function processPdf(pdfPath) {
      try {
        modifications = extractModifications(jsonData);
        currentIssueIndex = -1;
        issueElements = [];
      
        updateProgress(10, 'Loading PDF document...');
      
        const pdf = await pdfjsLib.getDocument({
          url: pdfPath,
          cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@2.11.338/cmaps/',
          cMapPacked: true
        }).promise;

        let textItems = [];
        const totalPages = pdf.numPages;
      
        updateProgress(20, 'Extracting text from PDF...');
      
        for (let i = 1; i <= totalPages; i++) {
          loadingStatus.textContent = `Processing page ${i} of ${totalPages}...`;
          progressBar.style.width = `${20 + (i / totalPages * 60)}%`;
        
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent({
            normalizeWhitespace: true,
            disableCombineTextItems: false
          });
          
          textContent.items.forEach(item => {
            textItems.push({
              str: item.str,
              transform: item.transform,
              width: item.width,
              height: item.height
            });
          });
          textItems.push({ str: '\n\n', transform: [1, 0, 0, 1, 0, 0] });
        }
      
        updateProgress(85, 'Formatting text...');
        originalText = reconstructTextWithFormatting(textItems);
      
        updateProgress(90, 'Applying modifications...');
        displayOriginalText(applyOriginalHighlights(originalText, modifications));
        displayModifiedText(applyModifiedHighlights(originalText, modifications));

        issueElements = Array.from(document.querySelectorAll('.highlight-high, .highlight-medium'));
        issueElements.sort((a, b) => a.offsetTop - b.offsetTop);

        updateProgress(95, 'Finalizing...');
      
        document.getElementById('loading').style.display = 'none';
        progressContainer.style.display = 'none';
        document.getElementById('comparison').style.display = 'flex';
        document.getElementById('navigation').style.display = 'flex';
        document.getElementById('exportBtn').style.display = 'inline-flex';
        emptyState.style.display = 'none';

        if (issueElements.length > 0) {
          navigateToIssue(0);
        } else {
          document.getElementById('navigation').style.display = 'none';
        }
      
        updateProgress(100, 'Analysis complete');
      } catch (error) {
        console.error('Error processing PDF:', error);
        showError('Error processing PDF: ' + error.message);
      }
    }

    function updateProgress(percent, message) {
      progressBar.style.width = `${percent}%`;
      statusText.textContent = message;
      loadingStatus.textContent = message;
    }

    function navigateToIssue(index) {
      if (index < 0 || index >= issueElements.length) return;
    
      currentIssueIndex = index;
      const issueElement = issueElements[index];
      const viewer = document.getElementById('originalViewer');
    
      const elementRect = issueElement.getBoundingClientRect();
      const absoluteElementTop = elementRect.top + window.pageYOffset;
      const middlePosition = absoluteElementTop - (viewer.clientHeight / 2) + (elementRect.height / 2);
    
      isScrolling = true;
      viewer.scrollTo({
        top: middlePosition,
        behavior: 'smooth'
      });

      issueElements.forEach((el, i) => {
        if (i === index) el.classList.add('current-highlight');
        else el.classList.remove('current-highlight');
      });

      document.getElementById('prevBtn').disabled = index === 0;
      document.getElementById('nextBtn').disabled = index === issueElements.length - 1;
      
      setTimeout(() => {
        isScrolling = false;
      }, 500);
    }

    function reconstructTextWithFormatting(textItems) {
      let result = '';
      let lastY = null;
      let currentLine = [];
      const lines = [];

      textItems.forEach(item => {
        const y = Math.round(item.transform[5]);
        if (lastY === null) {
          lastY = y;
          currentLine.push(item);
        } else if (y === lastY) {
          currentLine.push(item);
        } else {
          lines.push(currentLine);
          currentLine = [item];
          lastY = y;
        }
      });

      if (currentLine.length > 0) lines.push(currentLine);

      lines.forEach(line => {
        line.sort((a, b) => a.transform[4] - b.transform[4]);
        let lineText = '';
        let lastX = 0;
        line.forEach(item => {
          const x = item.transform[4];
          if (x > lastX + 5) {
            const spaceCount = Math.round((x - lastX) / 8);
            lineText += ' '.repeat(Math.max(0, spaceCount));
          }
          lineText += item.str;
          lastX = x + (item.width * item.transform[0]);
        });
        result += lineText + '\n';
      });

      return result;
    }

    function applyOriginalHighlights(text, modifications) {
      let result = text;
      modifications.forEach(mod => {
        const escaped = escapeRegExp(mod.originalContent);
        const cls = mod.riskLevel === 'high' ? 'highlight-high' : 'highlight-medium';
        const tooltipCls = mod.riskLevel === 'high' ? 'high-tooltip' : 'medium-tooltip';
        const explain = mod.riskExplain || mod.ruleTitle || 'No explanation provided';
        const icon = mod.riskLevel === 'high' ? 'fa-exclamation-circle' : 'fa-exclamation-triangle';
      
        if (result.includes(mod.originalContent)) {
          result = result.replace(
            new RegExp(escaped, 'g'),
            `<span class="modification-tooltip ${cls} ${tooltipCls}">${mod.originalContent}<span class="tooltiptext"><div class="tooltip-title"><i class="fas ${icon}"></i> ${mod.ruleTitle}</div>${explain}</span></span>`
          );
        }
      });
      return result.replace(/\n/g, '<br>');
    }

    function applyModifiedHighlights(text, modifications) {
      let result = text;
      modifications.forEach(mod => {
        const escaped = escapeRegExp(mod.originalContent);
        const explain = mod.riskExplain || mod.ruleTitle || 'No explanation provided';
        const icon = mod.riskLevel === 'high' ? 'fa-exclamation-circle' : 'fa-exclamation-triangle';
      
        if (result.includes(mod.originalContent)) {
          result = result.replace(
            new RegExp(escaped, 'g'),
            `<span class="modification-tooltip highlight-replacement replacement-tooltip">${mod.resultContent}<span class="tooltiptext"><div class="tooltip-title"><i class="fas ${icon}"></i> ${mod.ruleTitle}</div>${explain}</span></span>`
          );
        }
      });
      return result.replace(/\n/g, '<br>');
    }

    function displayOriginalText(text) {
      document.getElementById('originalPdf').innerHTML = text;
    }

    function displayModifiedText(text) {
      document.getElementById('modifiedPdf').innerHTML = text;
    }

    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function showError(message) {
      document.getElementById('loading').style.display = 'none';
      progressContainer.style.display = 'none';
    
      const errorElement = document.getElementById('error');
      errorElement.style.display = 'block';
      document.getElementById('errorText').textContent = message;
    
      analyzeBtn.disabled = false;
    }
    
    async function exportModifiedPDF() {
      exportModal.style.display = 'none';
      const loadingElement = document.getElementById('loading');
      loadingElement.style.display = 'flex';
      loadingStatus.textContent = 'Generating modified PDF document...';
      
      try {
        // Create a temporary container with forced light theme styling
        const tempContainer = document.createElement('div');
        tempContainer.style.width = '800px';
        tempContainer.style.padding = '40px';
        tempContainer.style.background = 'white';
        tempContainer.style.color = 'black'; // Force black text
        tempContainer.style.fontFamily = 'Arial Unicode MS, SimSun, sans-serif';
        tempContainer.style.whiteSpace = 'pre';
        tempContainer.style.lineHeight = '1.6';
        
        // Clone the modified content
        const modifiedContent = document.getElementById('modifiedPdf').cloneNode(true);
        
        // Force black text and proper highlighting colors for all elements
        const allElements = modifiedContent.querySelectorAll('*');
        allElements.forEach(el => {
          el.style.color = 'black !important';
          el.style.backgroundColor = el.classList.contains('highlight-high') ? 'rgba(255, 0, 0, 0.2)' : 
                                    el.classList.contains('highlight-medium') ? 'rgba(255, 165, 0, 0.2)' : 
                                    el.classList.contains('highlight-replacement') ? 'rgba(0, 128, 0, 0.2)' : 
                                    'transparent';
        });
        
        // Force black text on the root element too
        modifiedContent.style.color = 'black !important';
        tempContainer.appendChild(modifiedContent);
        tempContainer.innerHTML = tempContainer.innerHTML.replace(/<br>/g, '\n');
        
        document.body.appendChild(tempContainer);
        
        const canvas = await html2canvas(tempContainer, {
          scale: 2,
          logging: false,
          useCORS: true,
          allowTaint: true,
          scrollX: 0,
          scrollY: -window.scrollY,
          backgroundColor: '#ffffff' // Force white background
        });
        
        document.body.removeChild(tempContainer);
        
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF({
          orientation: 'p',
          unit: 'mm',
          format: 'a4',
          filters: ['ASCIIHexEncode']
        });
        
        const imgWidth = 190;
        const pageHeight = 277;
        const imgHeight = canvas.height * imgWidth / canvas.width;
        let heightLeft = imgHeight;
        let position = 10;
        
        pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        
        while (heightLeft >= 0) {
          position = heightLeft - imgHeight + 10;
          pdf.addPage();
          pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }
        
        pdf.save('modified-contract.pdf');
        loadingElement.style.display = 'none';
        
        const errorElement = document.getElementById('error');
        errorElement.innerHTML = '<i class="fas fa-check-circle"></i> Modified PDF exported successfully!';
        errorElement.style.display = 'block';
        errorElement.style.color = 'var(--success)';
        errorElement.style.background = 'rgba(76, 201, 240, 0.1)';
        
        setTimeout(() => {
          errorElement.style.display = 'none';
        }, 3000);
      } catch (error) {
        console.error('Error generating PDF:', error);
        loadingElement.style.display = 'none';
        showError('Error generating PDF: ' + error.message);
      }
    }

    async function exportModificationsSummary() {
      exportModal.style.display = 'none';
      const loadingElement = document.getElementById('loading');
      loadingElement.style.display = 'flex';
      loadingStatus.textContent = 'Generating modifications summary...';
      
      try {
        // Create a temporary container with forced light theme styling
        const tempContainer = document.createElement('div');
        tempContainer.style.width = '800px';
        tempContainer.style.padding = '40px';
        tempContainer.style.background = 'white';
        tempContainer.style.color = 'black'; // Force black text
        tempContainer.style.fontFamily = 'Arial Unicode MS, SimSun, sans-serif';
        
        // Build the summary HTML with forced black text
        let htmlContent = `
          <h1 style="text-align: center; color: #1768e4 !important;">合同修改摘要</h1>
          <p style="text-align: center; color: #666 !important;">生成于 ${new Date().toLocaleDateString('zh-CN')}</p>
          <h2 style="color: #1768e4 !important;">修改统计</h2>
          <p style="color: black !important;">- 高风险问题: ${document.getElementById('highCount').textContent}</p>
          <p style="color: black !important;">- 中等风险问题: ${document.getElementById('mediumCount').textContent}</p>
          <p style="color: black !important;">- 总修改数: ${document.getElementById('totalCount').textContent}</p>
          <h2 style="color: #1768e4 !important;">修改列表</h2>
        `;
        
        modifications.forEach((mod, index) => {
          htmlContent += `
            <div style="margin-bottom: 20px; color: black !important;">
              <h3 style="font-weight: bold; color: black !important;">${index + 1}. ${mod.ruleTitle || '修改'} (${mod.riskLevel.toUpperCase()})</h3>
              <p style="color: #960000 !important; font-weight: bold;">原内容:</p>
              <p style="white-space: pre-wrap; margin-left: 20px; color: black !important;">${mod.originalContent}</p>
              <p style="color: #006400 !important; font-weight: bold;">修改后:</p>
              <p style="white-space: pre-wrap; margin-left: 20px; color: black !important;">${mod.resultContent}</p>
              <hr style="border-top: 1px solid #ccc; margin: 10px 0;">
            </div>
          `;
        });
        
        tempContainer.innerHTML = htmlContent;
        document.body.appendChild(tempContainer);
        
        const canvas = await html2canvas(tempContainer, {
          scale: 2,
          logging: false,
          useCORS: true,
          backgroundColor: '#ffffff' // Force white background
        });
        
        document.body.removeChild(tempContainer);
        
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF({
          orientation: 'p',
          unit: 'mm',
          format: 'a4'
        });
        
        const imgWidth = 190;
        const pageHeight = 277;
        const imgHeight = canvas.height * imgWidth / canvas.width;
        let heightLeft = imgHeight;
        let position = 10;
        
        pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        
        while (heightLeft >= 0) {
          position = heightLeft - imgHeight + 10;
          pdf.addPage();
          pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }
        
        pdf.save('contract-modifications-summary.pdf');
        loadingElement.style.display = 'none';
        
        const errorElement = document.getElementById('error');
        errorElement.innerHTML = '<i class="fas fa-check-circle"></i> 修改摘要导出成功!';
        errorElement.style.display = 'block';
        errorElement.style.color = 'var(--success)';
        errorElement.style.background = 'rgba(76, 201, 240, 0.1)';
        
        setTimeout(() => {
          errorElement.style.display = 'none';
        }, 3000);
      } catch (error) {
        console.error('Error generating summary PDF:', error);
        loadingElement.style.display = 'none';
        showError('生成摘要PDF时出错: ' + error.message);
      }
    }

    // Initialize the app
    document.addEventListener('DOMContentLoaded', () => {
      checkThemePreference();
      initEventListeners();
    });
</script>
  
  <!-- Include your script.js file which should contain the jsonData variable -->

</body>
</html>